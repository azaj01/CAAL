---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/caal/settings.py
  - src/caal/webhooks.py
  - frontend/components/settings/settings-panel.tsx
  - mobile/lib/screens/settings_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can set language to 'en' or 'fr' in settings.json"
    - "Language setting is readable by frontend via /api/settings"
    - "Language setting is readable by mobile via /settings endpoint"
    - "Existing settings.json without language key loads with 'en' default"
    - "New installation gets language: 'en' in settings"
  artifacts:
    - path: "src/caal/settings.py"
      provides: "Language setting default"
      contains: '"language": "en"'
    - path: "src/caal/webhooks.py"
      provides: "Language in setup wizard"
      contains: "language: str"
    - path: "frontend/components/settings/settings-panel.tsx"
      provides: "Frontend language type"
      contains: "language: string"
    - path: "mobile/lib/screens/settings_screen.dart"
      provides: "Mobile language state"
      contains: "_language"
  key_links:
    - from: "src/caal/settings.py"
      to: "settings.json"
      via: "DEFAULT_SETTINGS auto-migration"
      pattern: '"language":\\s*"en"'
    - from: "frontend/components/settings/settings-panel.tsx"
      to: "/api/settings"
      via: "loadSettings fetch"
      pattern: "settings\\.language"
---

<objective>
Add global language setting infrastructure to CAAL

Purpose: Enable all CAAL components (agent, frontend, mobile) to read a user's language preference. This is the foundation for full multilingual support.

Output:
- Language setting in DEFAULT_SETTINGS with "en" default
- SetupCompleteRequest accepts optional language field
- Frontend Settings interface includes language
- Mobile settings screen includes _language state
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Source files to modify
@src/caal/settings.py
@src/caal/webhooks.py
@frontend/components/settings/settings-panel.tsx
@mobile/lib/screens/settings_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language setting to backend</name>
  <files>
    src/caal/settings.py
    src/caal/webhooks.py
  </files>
  <action>
1. In `src/caal/settings.py`, add to DEFAULT_SETTINGS dict (after "wake_greetings" and before provider settings around line 47):

```python
# Language setting
"language": "en",  # ISO 639-1: "en" | "fr"
```

2. In `src/caal/webhooks.py`, update the SetupCompleteRequest class (around line 760) to include an optional language field:

```python
# Language setting (optional, defaults to "en")
language: str | None = None
```

3. In the complete_setup function (around line 851), add handling for the language field after processing other settings:

```python
# Language setting
if req.language:
    current["language"] = req.language
```

IMPORTANT:
- Place language in DEFAULT_SETTINGS BEFORE the provider settings block to maintain logical grouping
- The SetupCompleteRequest language field must be optional (defaults to None) for backward compatibility with existing setup wizard calls
- The complete_setup handler should only set language if explicitly provided (not None)
  </action>
  <verify>
1. Run `uv run python -c "from caal.settings import DEFAULT_SETTINGS; print(DEFAULT_SETTINGS.get('language'))"` - should print "en"
2. Run `uv run ruff check src/caal/settings.py src/caal/webhooks.py` - should pass
3. Run `uv run mypy src/caal/settings.py src/caal/webhooks.py --ignore-missing-imports` - should pass
  </verify>
  <done>
- DEFAULT_SETTINGS contains "language": "en"
- SetupCompleteRequest has optional language field
- complete_setup function handles language setting
- Linting and type checking pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add language setting to frontend and mobile</name>
  <files>
    frontend/components/settings/settings-panel.tsx
    mobile/lib/screens/settings_screen.dart
  </files>
  <action>
1. In `frontend/components/settings/settings-panel.tsx`:

   a. Add to the Settings interface (after min_endpointing_delay around line 44):
   ```typescript
   // Language
   language: string;
   ```

   b. Add to DEFAULT_SETTINGS constant (after min_endpointing_delay around line 82):
   ```typescript
   // Language
   language: 'en',
   ```

2. In `mobile/lib/screens/settings_screen.dart`:

   a. Add state field (after _wakeWordTimeout around line 71):
   ```dart
   // Language
   String _language = 'en';
   ```

   b. Find the _loadSettings method and ensure _language is loaded from response:
   ```dart
   _language = settings['language'] ?? 'en';
   ```

   c. Find the _saveSettings method and ensure _language is included in the settings map:
   ```dart
   'language': _language,
   ```

IMPORTANT:
- Keep the ordering consistent: language should be grouped logically (after turn detection, before any future settings)
- Frontend DEFAULT_SETTINGS must match backend DEFAULT_SETTINGS for the language key
- Mobile must use null-coalescing (??) to handle missing language key from older backends
  </action>
  <verify>
1. Run `cd frontend && pnpm build` - should compile without TypeScript errors
2. Run `cd frontend && pnpm lint` - should pass
3. Run `cd mobile && flutter analyze` - should pass with no errors
  </verify>
  <done>
- Frontend Settings interface includes language: string
- Frontend DEFAULT_SETTINGS includes language: 'en'
- Mobile _language state field exists
- Mobile loads and saves language setting
- All builds and linting pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Backend verification:**
   ```bash
   # Start agent (if not running)
   # curl http://localhost:8889/settings | jq '.settings.language'
   # Should return "en"
   ```

2. **Backward compatibility test:**
   ```bash
   # Create a settings.json without language key
   echo '{"agent_name": "Test"}' > /tmp/test_settings.json
   CAAL_SETTINGS_PATH=/tmp/test_settings.json uv run python -c "
   from caal.settings import load_settings
   s = load_settings()
   assert s['language'] == 'en', 'Missing language should default to en'
   print('Backward compatibility: PASS')
   "
   ```

3. **New installation test:**
   ```bash
   # Fresh settings should include language
   rm -f /tmp/new_settings.json
   CAAL_SETTINGS_PATH=/tmp/new_settings.json uv run python -c "
   from caal.settings import load_settings, save_settings
   s = load_settings()
   save_settings(s)
   import json
   with open('/tmp/new_settings.json') as f:
       saved = json.load(f)
   assert 'language' in saved, 'Saved settings should include language'
   print('New installation: PASS')
   "
   ```
</verification>

<success_criteria>
1. `DEFAULT_SETTINGS["language"] == "en"` in Python
2. `SetupCompleteRequest` accepts optional `language` field
3. Frontend `Settings` interface has `language: string`
4. Frontend `DEFAULT_SETTINGS.language === 'en'`
5. Mobile `_language` state field initialized to `'en'`
6. Mobile loads language from API response
7. Mobile includes language in save payload
8. Existing settings.json files without `language` key load successfully with `"en"` default
9. All linting (ruff, mypy, eslint, flutter analyze) passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
